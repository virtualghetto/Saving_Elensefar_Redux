#textdomain wesnoth-Saving_Elensefar

[scenario]
    id=sea_voyage_0
    name= _ "The High Seas"
    map_data="{~add-ons/Saving_Elensefar/maps/The_High_Seas.map}"
    turns=30
    victory_when_enemies_defeated=no

    [lua]
        code = << wesnoth.dofile("~add-ons/Saving_Elensefar/utils/wml-tags.lua") >>
    [/lua]

#define GUARD_SHIP x1 y1 x2 y2
    [unit]
        type="War Galleon"
        side=2
        ai_special=guardian
        x,y={x1},{y1}
        # for some reason I prefer the formula AI here
        [ai]
            loop_formula="{ai/formula/patrol.fai}"
            [vars]
                guard_radius=4
                waypoints=[ loc({x1},{y1}) -> loc({x2},{y2}), loc({x2},{y2}) -> loc({x1},{y1}) ]
                next_step="loc({x2},{y2})"
            [/vars]
        [/ai]
    [/unit]
#enddef

#define STORE_SCENARIO S
    ##store the Explorer
    [store_unit]
        [filter]
            id=The_Explorer
        [/filter]
        variable=shippy
        kill=yes
    [/store_unit]
    ##everyone else (enemy ships)
    [store_unit]
        [filter]
            [not]
                side=1
            [/not]
        [/filter]
        variable=everyoneelse
    [/store_unit]

    ##remember the turn number
    {VARIABLE timer $turn_number}

    ##remember the time-of-day
    {CLEAR_VARIABLE time}
    [store_time_of_day]
        variable=time
    [/store_time_of_day]

    ##get shroud data for Meneldur
    [store_shroud]
        side=1
        variable=side_1_shroud
    [/store_shroud]

    ##go to next scenario
    {SE_ENDLEVEL_CONTINUE_NO_SAVE}
    [+endlevel]
        next_scenario=sea_voyage_{S}
    [/endlevel]
#enddef

#define PORT V M
    ##capture all visited villages
    [event]
        name=prestart

        [filter_condition]
            [variable]
                name=started
                equals=yes
            [/variable]
        [/filter_condition]

        [if]
            [variable]
                name=isles.{V}.status
                equals=played
            [/variable]
            [then]
                [capture_village]
                    side=1
                    x,y=$isles.{V}.x,$isles.{V}.y
                [/capture_village]
            [/then]
        [/if]

        [if]
            [variable]
                name=isles.{V}.status
                equals=locked
            [/variable]
            [then]
                [terrain]
                    x,y=$isles.{V}.x,$isles.{V}.y
                    terrain=Mv
                [/terrain]
            [/then]
        [/if]

        [redraw]
            side=1
        [/redraw]
    [/event]

    ##what to do if moving to a village
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=1
            x,y=$isles.{V}.x,$isles.{V}.y
        [/filter]

        [switch]
            variable=isles.{V}.status
            [case]
                value=played
                {VARIABLE turnsleft 6}
                [message]
                    id=The_Explorer
                    caption=_ "Madru"
                    image="portraits/Madru.png"
                    message= _ "This island has no more enemies on it, but we can still reprovision here. That will still take time, though."
                [/message]
                [end_turn]
                [/end_turn]
            [/case]
            [case]
                value=retreated
                [message]
                    id=The_Explorer
                    caption=_ "Madru"
                    image="portraits/Madru.png"
                    message= _ "We have unfinished business to attend to."
                [/message]
                {VARIABLE isles.{V}.status played}
                {STORE_SCENARIO {V}}
            [/case]
            [case]
                value=playable
                {VARIABLE isles.{V}.status played}
                {M}
                {STORE_SCENARIO {V}}
            [/case]
        [/switch]
    [/event]
#enddef

    {DEFAULT_SCHEDULE_SECOND_WATCH}
    {MOOD_CALM}

    {MENELDUR_SIDE}
    [+side]
        shroud=yes
        fog=yes
        village_gold=0
        income=-2
    [/side]

    [side]
        side=2
        no_leader=yes
        controller=ai
        [ai]
            version=10703
            [stage]
                engine=fai
                name=unit_formulas
            [/stage]
        [/ai]
    [/side]

    [event]
        name=already_started

        # update shroud data
        [set_shroud]
            side=1
            shroud_data=$side_1_shroud
        [/set_shroud]

        # set supply limit
        {IF_VAR retreatednotwon equals yes (
            [then]
                {VARIABLE retreatednotwon no}
            [/then]
            [else]
                {VARIABLE turnsleft 6}
            [/else]
        )}

        #unstore units
        {VARIABLE shippy.moves 4}
        [unstore_unit]
            variable=shippy
        [/unstore_unit]

        {FOREACH everyoneelse a}
            {VARIABLE everyoneelse[$a].moves 4}
            [unstore_unit]
                variable=everyoneelse[$a]
            [/unstore_unit]
        {NEXT a}

        #place shipwrecks
        {FOREACH sunkenships b}
            [item]
                x,y=$sunkenships[$b].x,$sunkenships[$b].y
                image="scenery/wreck.png"
            [/item]
        {NEXT b}

        # set up timer
        [modify_turns]
            value=30
            current=$timer
        [/modify_turns]

        # Ready
        [redraw]
            side=1
        [/redraw]
    [/event]

    [event]
        name=first_visit

        # initialize this variables
        {VARIABLE shipgold 100}
        {VARIABLE turnsleft 6}

        #wesnoths army
        {GUARD_SHIP 61 13 54 4}
        {GUARD_SHIP 40 16 52 14}
        {GUARD_SHIP 47 10 40 3}
        {GUARD_SHIP 21 4 22 14}
        {GUARD_SHIP 18 18 37 11}
#ifdef NORMAL
        {GUARD_SHIP 52 14 40 16}
        {GUARD_SHIP 37 11 18 18}
#endif
#ifdef HARD
        {GUARD_SHIP 40 3 47 10}
        {GUARD_SHIP 22 14 21 4}
        {GUARD_SHIP 52 14 40 16}
        {GUARD_SHIP 37 11 18 18}
#endif

        [set_variables]
            name=isles
            [value]
                [1]
                    status=playable
                    x,y=50,4
                    id=swampland
                [/1]
                [2]
                    status=playable
                    x,y=42,13
                    id=orc_mountain
                [/2]
                [3]
                    status=playable
                    x,y=37,7
                    id=theft
                [/3]
                [5]
                    status=playable
                    x,y=28,14
                    id=fire_island
                [/5]
                [6]
                    status=playable
                    x,y=18,11
                    id=traitors
                [/6]
                [8]
                    status=playable
                    x,y=5,5
                    id=frozen_lands
                [/8]
                [9]
                    status=playable
                    x,y=40,18
                    id=tri
                [/9]
                [12]
                    status=playable
                    x,y=17,8
                    id=desert_island
                [/12]
                [13]
                    status=playable
                    x,y=5,17
                    id=ruined_port
                [/13]
                [14]
                    status=playable
                    x,y=4,12
                    id=blackmore
                [/14]
                [15]
                    status=playable
                    x,y=57,13
                    id=alduin_academy
                [/15]
                [16]
                    status=playable
                    x,y=22,20
                    id=goblin_isle
                [/16]
                [17]
                    status=playable
                    x,y=68,17
                    id=saurian_trap
                [/17]
                [18]
                    status=playable
                    x,y=51,18
                    id=cave_illirien
                [/18]
                [19]
                    status=playable
                    x,y=24,1
                    id=illaryan
                [/19]
            [/value]
        [/set_variables]

        [unit]
            side=1
            x,y=59,2
            type=Black Galleon
            canrecruit=yes
            id=The_Explorer
            name= _"The Explorer"
            random_traits=no
            {IS_EXPENDABLE_LEADER}
        [/unit]

        [redraw]
            side=1
        [/redraw]
    [/event]

    [event]
        name=prestart

        # dont carryover recruitlist
        [recall]
            id=Madru
            x,y=1,1
        [/recall]
        [recall]
            id="Black the Red"
            x,y=2,2
        [/recall]

        [set_extra_recruit]
            id=Meneldur
            extra_recruit=""
        [/set_extra_recruit]
        [set_extra_recruit]
            id=Madru
            extra_recruit=""
        [/set_extra_recruit]
        [set_extra_recruit]
            id="Black the Red"
            extra_recruit=""
        [/set_extra_recruit]

        {PUT_TO_RECALL_LIST (id=Madru)}
        {PUT_TO_RECALL_LIST (id="Black the Red")}

        {PUT_TO_RECALL_LIST (id=Meneldur)}

        ##scatter some images
        [item]
            x,y=50,18
            image="scenery/rock4.png"
        [/item]
        [item]
            x,y=28,4
            image="scenery/whirlpool.png"
        [/item]
        [item]
            x,y=57,3
            image="scenery/shipwreck-1.png"
        [/item]
        [item]
            x,y=41,12
            image="scenery/mine-abandoned.png"
        [/item]
        [item]
            x,y=39,18
            image="units/human-loyalists/spearman.png~RC(magenta>blue)"
        [/item]
        [item]
            x,y=17,11
            image="units/elves-wood/fighter.png~RC(magenta>green)"
        [/item]

        {IF_VAR started equals yes (
            [then]
                [fire_event]
                    name=already_started
                [/fire_event]
            [/then]
            [else]
                [fire_event]
                    name=first_visit
                [/fire_event]
            [/else]
        )}

        [objectives]
            side=1
            summary= _ "Scenario Rules:"
            [objective]
                description="<span color='white'>"+ _"Land in a harbor to reprovision."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"The Wesnothian ships are chasing you; if they attack you they will attempt to board the ship."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Each of their ships has enough provisions to completely restock your ship."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Your long-term objective is to reach the lands in the West where Black the Red says there are allies, and have them join you."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Until then you cannot return to Elensefar."+"</span>"
                condition=win
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Be at sea for 6 weeks (6 turns) without reprovisioning"+"<small>"+ _"(current $turnsleft provisions remaining)"+"</small></span>"
                condition=lose
            [/objective]
            [objective]
                description="<span color='white'>"+ _"Take more than 30 weeks to reach the western lands"+"</span>"
                show_turn_counter=yes
                condition=lose
            [/objective]
        [/objectives]
    [/event]

    [event]
        name=start

        [scroll_to_unit]
            id=The_Explorer
        [/scroll_to_unit]

        {IF_VAR started not_equals yes (
            [then]
                [message]
                    id=The_Explorer
                    caption=_ "Madru"
                    image="portraits/Madru.png"
                    message= _ "We have left Elensefar in the hands of the orcs. If we do not return soon, it will be of no use to return at all. We have at most 30 weeks to get to the western lands, where we will meet with the people Black the Red has spoken of. That will leave us with 5 weeks to get back."
                [/message]
                [delay]
                    time=250
                [/delay]
                [message]
                    id=The_Explorer
                    caption=_ "Madru"
                    image="portraits/Madru.png"
                    message= _ "Also, our ship cannot hold provisions for more than 6 weeks at a time, so we must either land on an island or capture an enemy ship ever 6 weeks."
                [/message]
                {VARIABLE started yes}
            [/then]
        )}
    [/event]

    ##tell the player how many time remains
    [event]
        name=side 1 turn
        first_time_only=no

        {VARIABLE gameleft "$(31-$turn_number)"}
        [if]
            [variable]
                name=turnsleft
                greater_than=1
            [/variable]
            [then]
                [message]
                    id=The_Explorer
                    caption=_ "Madru"
                    image="portraits/Madru.png"
                    message= _ "We only have enough provisions for $turnsleft weeks; we must reach the Western Lands in $gameleft weeks."
                [/message]
                {VARIABLE_OP turnsleft sub 1}
            [/then]
            [else]
                [if]
                    [variable]
                        name=turnsleft
                        numerical_equals=1
                    [/variable]
                    [then]
                        [message]
                            id=The_Explorer
                            caption=_ "Madru"
                            image="portraits/Madru.png"
                            message= _ "Hurry, we are down to our last provisions! If we don't refill them within a week, we will all starve!"
                        [/message]
                        {VARIABLE_OP turnsleft sub 1}
                    [/then]
                    [else]
                        [message]
                            id=The_Explorer
                            caption=_ "Madru"
                            image="portraits/Madru.png"
                            message= _ "We have ran out of provisions.... *urgh*"
                        [/message]
                        [endlevel]
                            result=defeat
                            reveal_map=no
                        [/endlevel]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]

    [event]
        name=side 1 turn end
        first_time_only=no
        {VARIABLE_OP scenario_number add 1}
    [/event]

    ##defeat condition
    [event]
        name=time over

        [message]
            id=The_Explorer
            caption=_ "Black the Red"
            image="portraits/Black_the_Red.png"
            message= _ "We have failed reaching the Westlands in time."
        [/message]
        [endlevel]
            result=defeat
            reveal_map=no
        [/endlevel]
    [/event]

    ##the sea battle
    [event]
        name=attack

        [filter]
            type=Black Galleon
        [/filter]

        [fire_event]
            name=seabattle
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
            [secondary_unit]
                x,y=$x2,$y2
            [/secondary_unit]
        [/fire_event]
    [/event]
    [event]
        name=attack

        [filter]
            type=War Galleon
        [/filter]

        [fire_event]
            name=seabattle
            [primary_unit]
                x,y=$x2,$y2
            [/primary_unit]
            [secondary_unit]
                x,y=$x1,$y1
            [/secondary_unit]
        [/fire_event]
    [/event]

    [event]
        name=seabattle

        {VARIABLE index "$sunkenships.length"}
        {VARIABLE sunkenships[$index].x $x2}
        {VARIABLE sunkenships[$index].y $y2}
        {CLEAR_VARIABLE index}

        #finding direction of attack
        [store_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            variable=temp
            kill=yes
        [/store_unit]

        [if]
            [variable]
                name=temp.x
                equals=$x1
            [/variable]
            [then]
                [if]
                    [variable]
                        name=temp.y
                        greater_than=$y1
                    [/variable]
                    [then]
                        {VARIABLE direction N}
                    [/then]
                    [else]
                        {VARIABLE direction S}
                    [/else]
                [/if]
            [/then]
            [else]
                [if]
                    [variable]
                        name=temp.x
                        greater_than=$x1
                    [/variable]
                    [then]
                        [if]
                            [variable]
                                name=temp.y
                                greater_than=$y1
                            [/variable]
                            [then]
                                {VARIABLE direction NW}
                            [/then]
                            [else]
                                {VARIABLE direction SW}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=temp.y
                                greater_than=$y1
                            [/variable]
                            [then]
                                {VARIABLE direction NE}
                            [/then]
                            [else]
                                {VARIABLE direction SE}
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]

        ##make sure it is dead
        [kill]
            x,y=$x2,$y2
        [/kill]

        {STORE_SCENARIO $direction}
        {CLEAR_VARIABLE temp,direction}
    [/event]

    {PORT 1 (
        # the swampland (othello game)
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "There does not seem to be anyone living on this island... except, it seems, that black-cowled man on the far side..."
        [/message]
    )}

    {PORT 2 (
        # orcish isle
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "Last time I was here there was a trading colony, but it seems to be gone. Their old stockades should still be here, anyway."
        [/message]
    )}

    {PORT 3 (
        # naga island (merman allies) (2 scenarios)
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "I think something is in the water..."
        [/message]
    )}

    {PORT 5 (
        # volcano isle (against drakes, outlaw allies)
        [message]
            id=The_Explorer
            caption=_ "Madru"
            image="portraits/Madru.png"
            message= _ "Legend says Haldric landed here on his journey over, and that he fought something. Lets hope we don't have to fight whatever it was..."
        [/message]
    )}

    {PORT 6 (
        # elvish/orcish island (2 scenarios)
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "This island looks vaguely elvish."
        [/message]
    )}

    {PORT 8 (
        # with and against dwarves
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "Does anything live in this frozen wasteland?"
        [/message]
    )}

    {PORT 9 (
        # wesnoth outpost (3 scenarios)
        [message]
            id=The_Explorer
            caption=_ "Madru"
            image="portraits/Madru.png"
            message= _ "I see signs of a Wesnothian outpost. Odd they would come so far south..."
        [/message]
    )}

    {PORT 12 (
        # desert_island
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "Nagas were about a hundred years ago, in Haldric's time! I wonder if any remain..."
        [/message]
    )}

    {PORT 13 (
        # no villages scenario
        [message]
            id=The_Explorer
            caption=_ "Black the Red"
            image="portraits/Black_the_Red.png"
            message= _ "This is old Clearwater Port! It was sacked by orcs long ago, I doubt there are any humans left."
        [/message]
    )}

    {PORT 14 (
        # final goal
        [message]
            id=The_Explorer
            caption=_ "Black the Red"
            image="portraits/Black_the_Red.png"
            message= _ "This is the land I was talking about. Land here, and we will get the warriors we need."
        [/message]
    )}

    {PORT 15 (
        # puzzle scenario (rescue mages)
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "The Great Academy of Alduin is settled on this isle! Let us hold here for a day or two."
        [/message]
    )}

    {PORT 16 (
        # goblins
        [message]
            id=The_Explorer
            caption=_ "Madru"
            image="portraits/Madru.png"
            message= _ "This island looks desert."
        [/message]
    )}

    {PORT 17 (
        # saurians
        [message]
            id=The_Explorer
            caption=_ "Madru"
            image="portraits/Madru.png"
            message= _ "Carefull with those riffs, or we will shipwreck"
        [/message]
    )}

    {PORT 18 (
        # cave_illirien (unbalanced)
        [message]
            id=The_Explorer
            caption=_ "Black the Red"
            image="portraits/Black_the_Red.png"
            message= _ "This is just an abandoned smugglers hole."
        [/message]
    )}

    {PORT 19 (
        # fight illusions
        [message]
            id=The_Explorer
            caption=_ "Meneldur"
            image="portraits/Meneldur.png"
            message= _ "There is a great tower on the isle. Which kind of mage live here?"
        [/message]
    )}
[/scenario]

#undef PORT V M
#undef GUARD_SHIP X Y
#undef STORE_SCENARIO S
